 
1. はじめに
1.1. 本書について
本書は私 chibiharu（以下、管理者と明記する）が設計・構築を行ったWebサービスの基盤システムの設計構築、及び運用保守について記載するものである。

1.2. 本書の記載範囲
本書は以下について記載します。
・本基盤システムの設計・構築における基本方針
・本基盤システムの運用・保守における基本方針

1.3. 本サービスの目的
・IT技術に関する知見をWeb上から第三者へ発信をすることで知識の整理に繋げる
・管理者の制作物（実績）として使用する

1.4. 本サービスの概要
今回、以下Webサイトのリリース、及び運用を行う。また、本書では以下Webサイトを総称して「本サービス」と明記する。
•	chibiNet(https://chibinfra-techblog.com/)
•	chibiharu’s Lab(https://chibinfra-techlab.com/)

本サービスはWordPressを使用し構築、リリースを行い、基盤システムとしてパブリッククラウド（AWS）を使用する。
 
1.5. 用語の定義
本設計書で使用する用語の定義は次表に示すとおりである。

表 1　用語の定義
用語	説明
	
	

 
2.  構成設計
2.1. 概要
本サービスの基盤システムにはパブリッククラウドサービスを使用し、IaaSにAWSを採用する。

2.2. 使用サービス
2.2.1 選定要件
本基盤環境で使用するサービスの選定は以下の要件に基づくものとする。
　・高いコストパフォーマンスを有していること
　・簡易な構築、及び運用を可能にすること
　・高い拡張性を有していること
　・高いセキュリティを有していること

2.2.2 使用サービス一覧
本環境で使用するサービスを下表のとおりとする。
	
表 2　使用機器一覧
No	サービス名	用途	説明
1	Amazon EC2	VPNクライアント	SoftEther Client

2	Amazon Lightsail	Webサーバ	Amazonの提供するVPSを使用することで簡易的な環境構築・運用を実現。

3	Amazon Route53	名前解決用	パブリックホストゾーンを作成することにより、本サービスの通信の名前解決を実現。
なお、ドメインはRoute53で作成、購入したものを使用する。

4	Amazon Simple Email Service	Webサイト経由のメール用	Amazon Lightsailはデフォルトではメールサーバーとしての機能を保持していないため、デフォルト設定ではWP側とのメール送受信が出来ない。
WordPressプラグインとAWS SESを併用し、両サービスでSMTP情報を連携することによりメールの送受信を実現。

5	Amazon Simple Nortification Service	AWSからの通知メール受付用	CloudWatch, Lambda等でのイベント時に管理者へメール通知を行う際に使用する。

6	Amazon S3	オブジェクト格納用	本サービスにおいて発生する全てのオブジェクトの格納先として使用する。

7	Amazon CloudWatch	サーバ監視用	EC2,Lightsailのサービス監視、ログ収集、及び解析に使用する。

8	Amazon Lambda	AWSサービスで使用する関数用	以下、機能の為使用する。
・CloudWatch LogsからAmazon S3へのログローテート

9	Softether Server / Client	VPN接続用	AWS VPCと自宅環境間のVPN接続を実現する。

10	LetsEncript	Webサイト暗号化用	SSL/TLS証明書の発行にはLetsencriptを使用。
Letsencriptで発行したSSL/TLS証明書の有効期限は”3ヶ月”のため、サービスの暗号化を永続的に行っていくには”3ヶ月以内”での証明書の再発行が必要となる。
上記課題に対して、証明書発行スクリプトを作成しCronでスクリプトを一定の周期で自動実行することで対策している。

11	Amazon VPC	VPNエンドポイント用	ChibiharuアカウントへのアクセスはVPNクライアントが置かれているデフォルトVPCを経由してアクセスするものとする。

	

2.3. 性能・容量
本環境で使用するサービスは、コスト面、及び使用用途の観点から、性能・容量についての要件は特に定めない。 但し、あまりにも性能が劣るために、生活、及びサービス運用に影響があると判断した場合には、速やかに改善措置を行うものとする。

 
2.4. 基盤構成図
本環境の基盤構成図を下表のとおりとする。

 
3. 運用設計
3.1. 概要
効率的なシステム運用管理を実現するために、本環境の運用管理は、原則として、AWSサービスを利用すること。また、運用管理は管理人のみが行うものとする。

3.2. 運用対象
運用対象を以下のとおりとする。
•	AWS上で管理するWebサービスに関連するサービス全て
•	自宅環境で管理するWebサービスい関連するサービス全て

3.3. 運用体制
本環境の運用管理は管理人のみで行うものとする

3.4. ユーザ管理
以下サービスについて、新たに管理用ユーザーを作成するものとし、当サービスの運用管理は管理用ユーザーをメインに使用するものとする。
•	AWS
•	Wordpress

また、Rootユーザーやスーパーユーザはセキュリティ上の管理から、原則として使用しないものとする。

3.5. 運用スケジュール
当サービスの定時で発生するメンテナンス作業については、原則として以下日時に実行するものとする。
•	0:00 – 4:00

上記時間外でのメンテナンス作業が発生する場合は、Webサイト上、またはSNSを通して事前に告知を行うものとする。

3.6. ジョブ管理
3.6.1 自動ジョブ
当サービスで発生する定時作業については、原則としてスケジュール登録するものとする。
別途ジョブ管理システムは用意せず、OS標準のジョブスケジュール管理システムを使用する。
また、定時作業は全てパラメータシートにて管理する。

3.6.2 手動ジョブ
スケジュール管理が不可能な定時ジョブについては、手動で行うものとし、サービスが影響が少ない時間帯を指定するものとする。

3.7. バックアップ/リストア管理
3.7.1 ファイルデータバックアップ
画像や動画等のメディアデータについては、ファイル単位でのバックアップを行うものとし、保管先にAmazon S3を指定する。
増分バックアップのみを取得するものとし、フルバックアップ、差分バックアップについては原則として取得しないものとする。
また、バックアップの取得、及び転送中、保管時は必ずデータを暗号化するものとし、管理人のみのアクセスのみが可能な状態にしておく。

3.7.2 イメージバックアップ
Amazon Lightsailの標準仕様である自動スナップショット機能を使用しOS単位でのスナップショットを取得する。

スナップショット処理は自動化されており以下の要件で行われる。

•	スケジュール：毎日＊時 ※システム標準時に準拠
•	世代管理：最大7世代まで可能 ※7世代目以上からは新たにスナップショットを取得すると古いスナップショットから削除されていく
•	保管先：AWS ※保管先については、標準仕様故AWS上のサーバーとなる。

3.8. ログ管理
3.8.1 ログ取得対象
運用対象を以下のとおりとする。
•	AWS上で管理するWebサービスに関連するサービス全て
•	自宅環境で管理するWebサービスい関連するサービス全て

3.8.2 ログ取得
各サービスのログの取得にはAmazon CloudWatchを使用する。
取得したログはCloudWatch Logsにて取得するものとする。

3.8.3 ログ保管
CloudWatch logsにて取得したログの保管期間は2周間と設定し、期間を過ぎたログに関しては削除するものとする。

3.8.4 ログローテート
CloudWatch logsにて取得したログは、指定の期間を過ぎるとAmazon S3へバックアップされるものとし、Amazon S3に保管したログはサービス廃止まで保管するものとする。
ログローテート機能の実現にAmazon Lambdaを使用し、ログローテートの状況は常に確認できるようにする。



 
4. 保守設計
4.1. 概要
本ネットワーク環境の保守は基本的にchibiharu一人で行うが、一部の作業はIT機器プロパイダーに委託する。

4.2. 保守方針
chibiharuが担当する保守業務は、本Webサービスの基盤システム全てを対象範囲とする。
基本的に24時間365日の保守体制を前提としているが、急遽、仕事等で自宅に帰宅できない場合はクラウドに精通している第三者に保守対応を依頼する場合もある。
作業においても全てchibiharuにて対応するものとしているが、一部ベンダー企業に作業を依頼する場合もある。

4.3. ハードウェア保守
今後のインフラ整備にあたり、ハードウェアの修理、または交換が必要になった場合、IT機器プロパイダーにその作業を委託する。
修理、交換の際は後述の「5.障害対応」に記載のポリシーに準拠するものとする。

4.4. ネットワーク機器の保守
今後のインフラ整備にあたり、ネットワーク機器の修理、または交換が必要になった場合、IT機器プロパイダーにその作業を委託する。
修理、交換の際は後述の「5.障害対応」に記載のポリシーに準拠するものとする。

4.5. 作業時におけるオペレーション
各ネットワーク機器の操作は原則踏み台PCから行う。
コンソールサーバーへRDP接続しコンソールサーバーから各機器へコンソール接続することでケーブル接続の手間を減らす。


 
4.6. 障害対応
4.6.1 障害対応方針
障害発生時はサービスの復旧を優先した障害対応を実施する。
障害対応時は必ず作業記録を取るものとし、記録をインシデントデータベースに保管し常に確認できるようにする。
共通事項として、障害時はサービス障害発生時より障害対象、原因、影響範囲、普及時間を早急に告知するものとする。

4.6.2 障害対応時の切り分け：AWS
以下サービスにて障害状況を確認し、AWSのアナウンスの内容に沿って、障害状況の告知を行う。
•	Amazon Service Health Dashboard
•	AWS Personal Health Dashboard
•	各AWSサービスのダッシュボード画面

4.6.3 障害対応時の切り分け：自宅環境
ネットワーク障害：Ping試験、トラフィックグラフの確認
ハードウェア障害：ランプ、コンフィグ画面での異常表示確認
OS、ミドルウェア：ランプ、コンフィグ画面での異常表示確認

4.6.4 作業記録
障害対応や仕様変更を行う際は、その作業記録を必ず取るものとし、以下の観点に基づき、指定のフォーマットにて作業記録表を作成すること。
•	アラーム発報
•	対応手順
•	障害の原因
•	今後の対策
 
5. 監視設計
5.1. 監視方針
基盤システム障害の早期検知を目的として、各サービス、サーバ、及びハードウェアの稼働状況を確認、監視を行う。
全体概要、監視システム、監視マニュアル、プロセスフローの基準書を作成し、監視レベルの標準化を図る。
監視は監視要件に沿って行う。その際に使用する監視フォーマットは別紙(監視フォーマット)を使用すること。
定常監視業務はは監視要件に従った時間に行う。
また障害が発生した際はインシデント報告書を作成しインシデントデータベースへ保管し常時確認が可能であること。

5.2. 監視要件
監視要件については別途ドキュメントにて記載する。

5.3. 監視対象
運用対象を以下のとおりとする。
•	AWS上で管理するWebサービスに関連するサービス全て
•	自宅環境で管理するWebサービスい関連するサービス全て

5.4. 通知
監視時に発報したアラーム、及び発見したエラーについては全てchibiharuにメールにて通知が送られるように監視システムを構築する。
 
6. セキュリティ設計
6.1. Webサービス、および、通信の暗号化について
本Webサービスの通信を暗号化することにより、本サービスで扱うデータへの不正アクセス、改ざん、及び外部への 持ち出しができないようにする。

暗号証明書の発行には、LetsEncryptを使用する。
LetsEncryptの使用にあたり以下の課題が発生する。

・課題
LetsEncryptは証明書を発行する機能しか持ち合わせていないため、サイト自体は暗号化されないので混合コンテンツ化してしまう。

上記課題に対し、以下の方法で対処する。

・対象方法
発行された証明書を利用してサイト自体を暗号化する機能を持つWordPressプラグインを導入することで混合コンテンツ化することを防ぐ。

6.2. 使用リソースの保管、及び暗号化について
本Webサービスで使用するドキュメントや画像や動画等のメディアファイルについては、全てAmazon S3にて管理・保管するものとする。
また、S3バケットはS3の標準の暗号化機能を使用して暗号化するものとする。

